<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>summa - Cargar Transacciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><filter id="noise" x="0" y="0" width="100%" height="100%"><feTurbulence type="fractalNoise" baseFrequency="0.75" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>');
            opacity: 0.03;
            pointer-events: none;
            z-index: 1;
        }
        .text-brand-primary { color: #1e40af; }
        .text-gradient {
            background-image: linear-gradient(to right, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .dot-gradient {
            background-image: linear-gradient(to right, #1e40af, #3b82f6);
        }
        .input-method-card {
            transition: all 0.3s ease;
        }
        .input-method-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(214, 74, 141, 0.15);
        }
        .input-method-card.selected {
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px rgba(214, 74, 141, 0.25);
            transform: translateY(-2px);
            border: 2px solid rgba(214, 74, 141, 0.3);
        }
        .whatsapp-card {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            transition: all 0.3s ease;
        }
        .whatsapp-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px rgba(37, 211, 102, 0.3);
        }
        .transaction-item {
            transition: all 0.2s ease;
        }
        .transaction-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-100 to-blue-200 text-gray-800">

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">
        <!-- Internal Navigation Bar -->
        <nav class="sticky top-0 z-50 mb-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <a href="dashboard.html" class="text-2xl font-bold text-brand-primary">summa</a>
                    </div>
                    <div class="flex items-center space-x-2 bg-white/30 backdrop-blur-xl rounded-full px-4 py-2">
                        <a href="dashboard.html" class="px-4 py-2 rounded-full font-medium transition-colors text-gray-700 hover:bg-white/40" id="nav-dashboard">Dashboard</a>
                        <a href="transactions.html" class="px-4 py-2 rounded-full font-medium transition-colors text-gray-700 hover:bg-white/40" id="nav-transactions">Registrar gasto</a>
                        <a href="transactions-overview.html" class="px-4 py-2 rounded-full font-medium transition-colors text-gray-700 hover:bg-white/40" id="nav-transactions-overview">Detalle transacciones</a>
                        <a href="budget.html" class="px-4 py-2 rounded-full font-medium transition-colors text-gray-700 hover:bg-white/40" id="nav-budget">Presupuesto</a>
                        <a href="account.html" class="px-4 py-2 rounded-full font-medium transition-colors text-gray-700 hover:bg-white/40" id="nav-account">Mi cuenta</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Page Title -->
        <section class="text-center my-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">
                <span class="text-gradient">Registrar</span> Gastos
            </h1>
            <p class="mt-4 text-lg text-gray-700">Elige la forma más conveniente para registrar tus gastos</p>
        </section>

        <!-- WhatsApp Quick Access Section -->
        <section class="mb-16">
            <div class="max-w-4xl mx-auto">
                <div class="whatsapp-card rounded-2xl p-8 text-white shadow-2xl">
                    <div class="flex flex-col lg:flex-row items-center justify-between">
                        <div class="text-center lg:text-left mb-6 lg:mb-0">
                            <div class="flex items-center justify-center lg:justify-start mb-4">
                                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-bold">¡Registra gastos por WhatsApp!</h2>
                            </div>
                            <p class="text-lg opacity-90 mb-4">La forma más rápida y fácil de registrar tus gastos</p>
                            <div class="space-y-2 text-sm opacity-80">
                                <p>• Envía un mensaje: "25.000 Uber 15/12"</p>
                                <p>• Graba un audio: "Gasté 50 mil en el supermercado ayer"</p>
                                <p>• Sube una foto del recibo directamente</p>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-4">
                            <button onclick="openWhatsApp()" class="px-8 py-4 bg-white text-green-600 font-bold rounded-xl hover:bg-gray-100 transition-colors flex items-center justify-center space-x-2">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                </svg>
                                <span>Abrir WhatsApp</span>
                            </button>
                            <div class="text-center">
                                <p class="text-sm opacity-75">Número: +57 300 123 4567</p>
                                <p class="text-xs opacity-60">Disponible 24/7</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alternative Methods Section -->
        <section class="mb-16">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Otras formas de registrar</h2>
                <p class="text-gray-600">Si prefieres usar la aplicación web</p>
            </div>
            
            <div class="flex justify-center w-full">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 w-full max-w-6xl">
                    <!-- Manual Input -->
                    <div id="option-manual" class="input-method-card rounded-xl bg-white/30 backdrop-blur-xl shadow-2xl overflow-hidden cursor-pointer transition-all duration-200" onclick="selectOption('manual')">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Registro Manual</h3>
                            <p class="text-gray-700 text-sm">Ingresa los datos de tu transacción manualmente</p>
                        </div>
                    </div>
                    <!-- Photo Input -->
                    <div id="option-photo" class="input-method-card rounded-xl bg-white/30 backdrop-blur-xl shadow-2xl overflow-hidden cursor-pointer transition-all duration-200" onclick="selectOption('photo')">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Foto del Recibo</h3>
                            <p class="text-gray-700 text-sm">Toma una foto o sube una imagen del recibo</p>
                        </div>
                    </div>
                    <!-- Voice Input -->
                    <div id="option-voice" class="input-method-card rounded-xl bg-white/30 backdrop-blur-xl shadow-2xl overflow-hidden cursor-pointer transition-all duration-200" onclick="selectOption('voice')">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Nota de Voz</h3>
                            <p class="text-gray-700 text-sm">Graba una nota de voz describiendo tu gasto</p>
                        </div>
                    </div>
                    <!-- CSV/PDF Upload -->
                    <div id="option-csv" class="input-method-card rounded-xl bg-white/30 backdrop-blur-xl shadow-2xl overflow-hidden cursor-pointer transition-all duration-200" onclick="selectOption('csv')">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">CSV o PDF</h3>
                            <p class="text-gray-700 text-sm">Carga archivos CSV o PDF con múltiples transacciones</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Input Forms (Hidden by default) -->
        <section id="inputForms" class="hidden mb-16">
            <!-- Manual Form -->
            <div id="manualForm" class="hidden">
                <div class="rounded-2xl bg-white/40 backdrop-blur-xl shadow-2xl p-6 border border-white/20 max-w-2xl mx-auto">
                    <!-- Header con icono -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Registro Manual</h2>
                                <p class="text-gray-600 text-sm">Ingresa los datos de tu transacción manualmente</p>
                            </div>
                        </div>
                        <button onclick="hideForms()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="manualTrxForm" class="space-y-6">
                        <div class="space-y-4 flex flex-col items-center">
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Comercio</label>
                                <input id="merchantInput" type="text" class="w-96 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="Uber, Rappi, ... McDonalds">
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Monto</label>
                                <input id="amountInput" type="number" step="0.01" class="w-96 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="0.00">
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Moneda</label>
                                <select id="currencySelect" class="w-96 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                    <option value="COP">COP - Peso Colombiano</option>
                                    <option value="USD">USD - Dólar Estadounidense</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Categoría</label>
                                <select id="categorySelect" class="w-96 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                    <option value="">Cargando categorías...</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Fecha</label>
                                <input id="dateInput" type="date" class="w-96 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div id="manualTrxMsg" class="text-center text-sm"></div>
                        
                        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                            <button type="button" onclick="hideForms()" class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" class="px-8 py-3 rounded-lg text-white font-semibold bg-[#1e40af] hover:opacity-95 transition-opacity">
                                Guardar Transacción
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Photo Form -->
            <div id="photoForm" class="hidden">
                <div class="rounded-2xl bg-white/40 backdrop-blur-xl shadow-2xl p-6 border border-white/20 max-w-2xl mx-auto">
                    <!-- Header con icono y botón de procesar -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Foto del Recibo</h2>
                                <p class="text-gray-600 text-sm">Sube una imagen de tu recibo para procesamiento automático</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="submit" id="processImageBtn" class="px-4 py-2 rounded-full text-white font-semibold bg-[#1e40af] hover:opacity-95 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                                Procesar
                            </button>
                            <button onclick="hideForms()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <form id="photoFormElement" class="space-y-6">
                        <!-- Área de carga de imagen -->
                        <div class="text-center">
                            <div id="imagePreviewContainer" class="w-64 h-64 mx-auto mb-4 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 transition-all duration-300 hover:border-pink-300 hover:shadow-lg" 
                                 ondrop="handleDrop(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeave(event)">
                                <div id="imagePreviewPlaceholder" class="text-center p-4">
                                                                    <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-r from-blue-100 to-indigo-100 flex items-center justify-center">
                                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-base font-semibold text-gray-800 mb-2">Sube tu recibo</h3>
                                    <p class="text-gray-600 text-sm mb-2">Arrastra una imagen aquí o haz clic para seleccionar</p>
                                    <p class="text-xs text-gray-500">JPG, PNG, PDF (máx. 10MB)</p>
                                </div>
                                <img id="imagePreview" class="w-full h-full object-cover rounded-xl hidden shadow-lg" alt="Vista previa de la imagen">
                            </div>
                            
                            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                            <button type="button" onclick="document.getElementById('imageInput').click()" class="px-6 py-2.5 rounded-full text-white font-semibold bg-[#1e40af] hover:opacity-95 transition-opacity text-sm">
                                Seleccionar Imagen
                            </button>
                        </div>
                        
                        <!-- Mensajes de estado -->
                        <div id="photoFormMsg" class="text-center text-sm"></div>
                        
                        <!-- Sección de procesamiento -->
                        <div id="processingSection" class="hidden">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                                <div class="flex items-center justify-center space-x-3">
                                    <div class="relative">
                                        <div class="animate-spin rounded-full h-6 w-6 border-4 border-blue-200 border-t-blue-600"></div>
                                    </div>
                                    <div>
                                        <p class="text-blue-800 font-medium text-sm">Procesando imagen con IA</p>
                                        <p class="text-blue-600 text-xs">Extrayendo datos del recibo...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Voice Form -->
            <div id="voiceForm" class="hidden">
                <div class="rounded-xl bg-white/30 backdrop-blur-xl shadow-2xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Nota de Voz</h2>
                        <button onclick="hideForms()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="text-center">
                        <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-r from-pink-400 to-purple-500 flex items-center justify-center">
                            <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-4">Presiona el botón y describe tu transacción</p>
                        <button class="px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-medium rounded-lg hover:opacity-90">Grabar Nota de Voz</button>
                    </div>
                </div>
            </div>


            <!-- CSV/PDF Upload Form -->
            <div id="csvForm" class="hidden">
                <div class="rounded-2xl bg-white/40 backdrop-blur-xl shadow-2xl p-6 border border-white/20 max-w-2xl mx-auto">
                    <!-- Header con icono -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">CSV o PDF</h2>
                                <p class="text-gray-600 text-sm">Carga archivos CSV o PDF con múltiples transacciones</p>
                            </div>
                        </div>
                        <button onclick="hideForms()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="csvFormElement" class="space-y-6">
                        <div class="text-center">
                            <div id="csvDropZone" class="w-64 h-32 mx-auto mb-4 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 transition-all duration-300 hover:border-pink-300 hover:shadow-lg cursor-pointer"
                                 ondrop="handleCsvDrop(event)" 
                                 ondragover="handleCsvDragOver(event)" 
                                 ondragleave="handleCsvDragLeave(event)"
                                 onclick="document.getElementById('csvFileInput').click()">
                                <div id="csvDropPlaceholder" class="text-center p-4">
                                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-gradient-to-r from-blue-100 to-indigo-100 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-sm font-semibold text-gray-800 mb-1">Sube tu archivo</h3>
                                    <p class="text-xs text-gray-500">CSV o PDF (máx. 10MB)</p>
                                </div>
                                <div id="csvFilePreview" class="hidden text-center p-4">
                                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-gradient-to-r from-green-100 to-green-200 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 id="csvFileName" class="text-sm font-semibold text-gray-800 mb-1"></h3>
                                    <p id="csvFileSize" class="text-xs text-gray-500"></p>
                                </div>
                            </div>
                            
                            <input type="file" id="csvFileInput" accept=".csv,.pdf" class="hidden" onchange="handleCsvFileSelect(event)" />
                            <button type="button" onclick="document.getElementById('csvFileInput').click()" class="px-6 py-2.5 rounded-full text-white font-semibold bg-[#1e40af] hover:opacity-95 transition-opacity text-sm">
                                Seleccionar Archivo
                            </button>
                        </div>
                        
                        <!-- Mensajes de estado -->
                        <div id="csvFormMsg" class="text-center text-sm"></div>
                        
                        <!-- Sección de procesamiento -->
                        <div id="csvProcessingSection" class="hidden">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                                <div class="flex items-center justify-center space-x-3">
                                    <div class="relative">
                                        <div class="animate-spin rounded-full h-6 w-6 border-4 border-blue-200 border-t-blue-600"></div>
                                    </div>
                                    <div>
                                        <p class="text-blue-800 font-medium text-sm">Procesando archivo CSV con IA</p>
                                        <p class="text-blue-600 text-xs">Extrayendo transacciones del archivo...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">Formatos soportados:</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• <strong>CSV:</strong> Archivos de Excel exportados como CSV</li>
                                <li>• <strong>PDF:</strong> Extractos bancarios o reportes financieros</li>
                            </ul>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                            <button type="button" onclick="hideForms()" class="px-6 py-3 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" class="px-8 py-3 rounded-lg text-white font-semibold bg-[#1e40af] hover:opacity-95 transition-opacity">
                                Procesar Archivo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Recent Transactions -->
        <section class="mb-16">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Últimas transacciones</h2>
            </div>
            <div class="glass rounded-xl shadow-2xl overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="bg-white/40">
                            <th class="px-4 py-3 text-left">Fecha</th>
                            <th class="px-4 py-3 text-left">Hora</th>
                            <th class="px-4 py-3 text-left">Comercio</th>
                            <th class="px-4 py-3 text-left">Categoría macro</th>
                            <th class="px-4 py-3 text-left">Categoría sub</th>
                            <th class="px-4 py-3 text-left">Valor</th>
                            <th class="px-4 py-3 text-left">Origen</th>
                            <th class="px-4 py-3 text-left">Confirmada</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsTableBody">
                        <tr><td colspan="8" class="text-center py-8 text-gray-500">Cargando transacciones...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- SUPABASE CLIENT ---
        const supabaseUrl = 'https://lvzoiylogngxpdzblxwg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2em9peWxvZ25neHBkemJseHdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NTQ0NzEsImV4cCI6MjA2NjEzMDQ3MX0.zMHL5kyzkIszJjaE3i6t1m_P0V8TO-VH9KiDp0e5CPQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Variable global para almacenar el usuario autenticado
        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            console.log('User authenticated:', user.email);
            console.log('User UUID:', user.id);
            
            // Cargar transacciones después de la autenticación
            await fetchRecentTransactions();
        });

        // Resalta la página activa como tab
        document.addEventListener('DOMContentLoaded', function() {
            const currentPage = window.location.pathname.split('/').pop() || 'dashboard.html';
            const activeTab = document.getElementById('nav-' + currentPage.replace('.html', ''));
            
            if (activeTab) {
                activeTab.classList.remove('text-gray-700');
                activeTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            }
        });

        // --- DOM ELEMENTS ---
        const categorySelect = document.getElementById('categorySelect');
        const merchantInput = document.getElementById('merchantInput');
        const amountInput = document.getElementById('amountInput');
        const dateInput = document.getElementById('dateInput');
        const manualTrxForm = document.getElementById('manualTrxForm');
        const manualTrxMsg = document.getElementById('manualTrxMsg');

        // --- FUNCTIONS ---
        const fetchCategories = async () => {
            try {
                const { data, error } = await supabase.from('categories').select('category_name');
                if (error) throw error;
                
                // Clear loading option
                categorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';
                
                // Add categories from database
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_name;
                    option.textContent = category.category_name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
                categorySelect.innerHTML = '<option value="">Error al cargar categorías</option>';
            }
        };

        function showManualForm() {
            hideForms();
            document.getElementById('inputForms').classList.remove('hidden');
            document.getElementById('manualForm').classList.remove('hidden');
            // Mantener resaltado en la opción manual
            selectOption('manual', false);
        }

        function showPhotoForm() {
            hideForms();
            document.getElementById('inputForms').classList.remove('hidden');
            document.getElementById('photoForm').classList.remove('hidden');
            // Mantener resaltado en la opción photo
            selectOption('photo', false);
        }

        function showVoiceForm() {
            hideForms();
            document.getElementById('inputForms').classList.remove('hidden');
            document.getElementById('voiceForm').classList.remove('hidden');
            // Mantener resaltado en la opción voice
            selectOption('voice', false);
        }



        function showCsvForm() {
            hideForms();
            document.getElementById('inputForms').classList.remove('hidden');
            document.getElementById('csvForm').classList.remove('hidden');
            // Mantener resaltado en la opción csv
            selectOption('csv', false);
        }

        function hideForms() {
            document.getElementById('inputForms').classList.add('hidden');
            document.getElementById('manualForm').classList.add('hidden');
            document.getElementById('photoForm').classList.add('hidden');
            document.getElementById('voiceForm').classList.add('hidden');
            document.getElementById('csvForm').classList.add('hidden');
            
            // Limpiar selección de opciones
            clearOptionSelection();
        }

        // Función para manejar la selección de opciones
        function selectOption(optionType, showForm = true) {
            // Limpiar selección anterior
            clearOptionSelection();
            
            // Resaltar la opción seleccionada
            const selectedOption = document.getElementById(`option-${optionType}`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Mostrar el formulario correspondiente solo si se solicita
            if (showForm) {
                switch(optionType) {
                    case 'manual':
                        showManualForm();
                        break;
                    case 'photo':
                        showPhotoForm();
                        break;
                    case 'voice':
                        showVoiceForm();
                        break;
                    case 'csv':
                        showCsvForm();
                        break;
                }
            }
        }

        // Función para limpiar la selección de opciones
        function clearOptionSelection() {
            const options = ['manual', 'photo', 'voice', 'csv'];
            options.forEach(option => {
                const element = document.getElementById(`option-${option}`);
                if (element) {
                    element.classList.remove('selected');
                }
            });
        }

        manualTrxForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            manualTrxMsg.textContent = '';
            
            // Verificar que el usuario esté autenticado
            if (!currentUser) {
                manualTrxMsg.textContent = 'Error: Usuario no autenticado';
                manualTrxMsg.className = 'text-center text-sm text-red-600';
                return;
            }
            
            const merchant = merchantInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const currency = document.getElementById('currencySelect').value;
            const category = categorySelect.value;
            const date = dateInput.value;
            
            if (!merchant || !amount || !currency || !category || !date) {
                manualTrxMsg.textContent = 'Por favor completa todos los campos';
                manualTrxMsg.className = 'text-center text-sm text-red-600';
                return;
            }
            
            manualTrxMsg.textContent = 'Guardando...';
            manualTrxMsg.className = 'text-center text-sm text-gray-600';
            
            try {
                const { error } = await supabase.from('transactions').insert([
                    {
                        user_id: currentUser.id, // Incluir el ID del usuario
                        merchant,
                        amount,
                        category,
                        date,
                        confirmed: false,
                        currency: currency === 'other' ? 'COP' : currency,
                        source: 'manual',
                    }
                ]);
                
                if (error) {
                    console.error('Error al guardar transacción:', error);
                    manualTrxMsg.textContent = 'Error al guardar la transacción: ' + error.message;
                    manualTrxMsg.className = 'text-center text-sm text-red-600';
                } else {
                    manualTrxMsg.textContent = '¡Transacción guardada exitosamente!';
                    manualTrxMsg.className = 'text-center text-sm text-green-600';
                    manualTrxForm.reset();
                    
                    // Actualizar la tabla de transacciones
                    setTimeout(() => {
                        fetchRecentTransactions();
                    }, 500);
                }
            } catch (error) {
                console.error('Error inesperado:', error);
                manualTrxMsg.textContent = 'Error inesperado al guardar la transacción';
                manualTrxMsg.className = 'text-center text-sm text-red-600';
            }
        });

        // Cargar últimas 5 transacciones reales
        async function fetchRecentTransactions() {
            try {
                // Verificar que el usuario esté autenticado
                if (!currentUser) {
                    console.log('Usuario no autenticado, esperando...');
                    return;
                }

                console.log('Cargando transacciones para usuario:', currentUser.id);
                
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUser.id) // Filtrar por usuario
                    .order('created_at', { ascending: false }) // Ordenar por fecha de creación
                    .limit(5);
                
                if (error) {
                    console.error('Error al cargar transacciones:', error);
                    renderRecentTransactionsTable(null, error);
                    return;
                }
                
                console.log('Transacciones cargadas:', data);
                renderRecentTransactionsTable(data, null);
                
            } catch (error) {
                console.error('Error en fetchRecentTransactions:', error);
                renderRecentTransactionsTable(null, error);
            }
        }
        function renderRecentTransactionsTable(data, error) {
            const tbody = document.getElementById('recentTransactionsTableBody');
            tbody.innerHTML = '';
            
            if (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-red-500">Error al cargar transacciones: ${error.message}</td></tr>`;
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">No hay transacciones para mostrar. ¡Registra tu primer gasto!</td></tr>`;
                return;
            }
            
            data.forEach(trx => {
                // Formatear fecha
                let fecha = '';
                let hora = '';
                if (trx.created_at) {
                    const date = new Date(trx.created_at);
                    fecha = date.toLocaleDateString('es-CO');
                    hora = date.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                } else if (trx.date) {
                    fecha = trx.date;
                    hora = trx.time || '';
                }
                
                // Formatear valor monetario
                let valor = '';
                if (trx.amount) {
                    const currency = trx.currency || 'COP';
                    valor = Number(trx.amount).toLocaleString('es-CO', { 
                        style: 'currency', 
                        currency: currency,
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                }
                
                // Obtener otros campos
                const comercio = trx.merchant || 'Sin especificar';
                const categoria = trx.category || 'Sin categorizar';
                const origen = trx.source || 'manual';
                const confirmada = trx.confirmed ? '✅ Sí' : '❌ No';
                
                // Clase CSS para el estado de confirmación
                const confirmadaClass = trx.confirmed ? 'text-green-600' : 'text-red-600';
                
                tbody.innerHTML += `
                    <tr class="border-b border-white/20 hover:bg-white/20 transition-colors">
                        <td class="px-4 py-3 text-sm">${fecha}</td>
                        <td class="px-4 py-3 text-sm">${hora}</td>
                        <td class="px-4 py-3 font-medium">${comercio}</td>
                        <td class="px-4 py-3 text-sm">${categoria}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">-</td>
                        <td class="px-4 py-3 font-semibold">${valor}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">${origen}</span>
                        </td>
                        <td class="px-4 py-3 text-sm ${confirmadaClass}">${confirmada}</td>
                    </tr>
                `;
            });
        }

        // Load shared navigation
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('navbar.html');
                const navbarHtml = await response.text();
                document.getElementById('navbar-container').innerHTML = navbarHtml;
            } catch (error) {
                console.error('Error loading navbar:', error);
            }
        });

        // --- PHOTO FORM FUNCTIONS ---
        let selectedImageFile = null;

        // Drag and Drop functions
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    // Simular el evento change del input
                    const input = document.getElementById('imageInput');
                    input.files = files;
                    handleImageSelect({ target: input });
                } else {
                    showPhotoMessage('Por favor arrastra solo archivos de imagen', 'error');
                }
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar que sea una imagen
            if (!file.type.startsWith('image/')) {
                showPhotoMessage('Por favor selecciona un archivo de imagen válido', 'error');
                return;
            }

            // Validar tamaño (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showPhotoMessage('La imagen debe ser menor a 10MB', 'error');
                return;
            }

            selectedImageFile = file;
            displayImagePreview(file);
            enableProcessButton();
            showPhotoMessage('Imagen seleccionada correctamente', 'success');
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                const placeholder = document.getElementById('imagePreviewPlaceholder');
                
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function enableProcessButton() {
            const processBtn = document.getElementById('processImageBtn');
            processBtn.disabled = false;
            processBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function showPhotoMessage(message, type) {
            const msgElement = document.getElementById('photoFormMsg');
            msgElement.textContent = message;
            msgElement.className = `text-center text-sm ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600'}`;
        }

        function showProcessingSection() {
            document.getElementById('processingSection').classList.remove('hidden');
            document.getElementById('processImageBtn').disabled = true;
        }

        function hideProcessingSection() {
            document.getElementById('processingSection').classList.add('hidden');
            document.getElementById('processImageBtn').disabled = false;
        }

        // Configuración del webhook de n8n
        const N8N_WEBHOOK_URL = 'https://mateof50.app.n8n.cloud/webhook-test/receive-receipt';
        
        // Función para verificar si la URL del webhook está configurada correctamente
        function isWebhookConfigured() {
            return N8N_WEBHOOK_URL && 
                   N8N_WEBHOOK_URL.startsWith('http');
        }

        // Manejar envío del formulario de foto
        document.getElementById('photoFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedImageFile) {
                showPhotoMessage('Por favor selecciona una imagen primero', 'error');
                return;
            }

            if (!isWebhookConfigured()) {
                showPhotoMessage('Error: El webhook no está configurado correctamente', 'error');
                return;
            }

            showProcessingSection();
            showPhotoMessage('Enviando imagen al servidor...', 'info');

            try {
                // Crear FormData para enviar la imagen
                const formData = new FormData();
                formData.append('image', selectedImageFile);
                formData.append('userId', (await supabase.auth.getUser()).data.user.id);
                formData.append('timestamp', new Date().toISOString());

                // Enviar al webhook de n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const result = await response.json();
                
                // Verificar si la respuesta indica éxito (incluyendo "Workflow was started")
                if (result.success || result.message === 'Workflow was started' || result.status === 'success') {
                    showPhotoMessage('¡Imagen cargada correctamente! El workflow ha sido iniciado y se procesará la imagen.', 'success');
                    
                    // Limpiar el formulario
                    document.getElementById('imageInput').value = '';
                    selectedImageFile = null;
                    document.getElementById('imagePreview').classList.add('hidden');
                    document.getElementById('imagePreviewPlaceholder').classList.remove('hidden');
                    document.getElementById('processImageBtn').disabled = true;
                    
                    // Actualizar la tabla de transacciones
                    fetchRecentTransactions();
                    
                    // Ocultar el formulario después de 3 segundos
                    setTimeout(() => {
                        hideForms();
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Error al procesar la imagen');
                }

            } catch (error) {
                console.error('Error procesando imagen:', error);
                
                // Verificar si el mensaje de error es en realidad un éxito
                if (error.message && error.message.includes('Workflow was started')) {
                    showPhotoMessage('¡Imagen cargada correctamente! El workflow ha sido iniciado y se procesará la imagen.', 'success');
                    
                    // Limpiar el formulario
                    document.getElementById('imageInput').value = '';
                    selectedImageFile = null;
                    document.getElementById('imagePreview').classList.add('hidden');
                    document.getElementById('imagePreviewPlaceholder').classList.remove('hidden');
                    document.getElementById('processImageBtn').disabled = true;
                    
                    // Actualizar la tabla de transacciones
                    fetchRecentTransactions();
                    
                    // Ocultar el formulario después de 3 segundos
                    setTimeout(() => {
                        hideForms();
                    }, 3000);
                    return;
                }
                
                // Manejo específico de errores de red
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showPhotoMessage('Error de conexión: No se pudo conectar con el servidor. Verifica tu conexión a internet.', 'error');
                } else if (error.message.includes('404')) {
                    showPhotoMessage('Error: El webhook no fue encontrado. Verifica la URL del webhook.', 'error');
                } else if (error.message.includes('500')) {
                    showPhotoMessage('Error del servidor: Problema interno en el procesamiento de la imagen.', 'error');
                } else if (error.message.includes('CORS')) {
                    showPhotoMessage('Error de CORS: El servidor no permite la conexión desde este dominio.', 'error');
                } else {
                    showPhotoMessage(`Error: ${error.message}`, 'error');
                }
            } finally {
                hideProcessingSection();
            }
        });

        // --- CSV UPLOAD FUNCTIONS ---
        let selectedCsvFile = null;
        // Removed n8n webhook URLs

        // Removed n8n webhook configuration check

        // Drag and Drop functions para CSV
        function handleCsvDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
        }

        function handleCsvDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
        }

        function handleCsvDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-pink-400', 'bg-gradient-to-br', 'from-pink-50', 'to-purple-50', 'shadow-lg');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.type === 'application/pdf' || file.name.endsWith('.csv') || file.name.endsWith('.pdf')) {
                    // Simular el evento change del input
                    const input = document.getElementById('csvFileInput');
                    input.files = files;
                    handleCsvFileSelect({ target: input });
                } else {
                    showCsvMessage('Por favor arrastra solo archivos CSV o PDF', 'error');
                }
            }
        }

        function handleCsvFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar que sea CSV o PDF
            const validTypes = ['text/csv', 'application/pdf'];
            const validExtensions = ['.csv', '.pdf'];
            const isValidType = validTypes.includes(file.type) || validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            
            if (!isValidType) {
                showCsvMessage('Por favor selecciona un archivo CSV o PDF válido', 'error');
                return;
            }

            // Validar tamaño (máximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showCsvMessage('El archivo debe ser menor a 10MB', 'error');
                return;
            }

            selectedCsvFile = file;
            displayCsvFilePreview(file);
            showCsvMessage('Archivo seleccionado correctamente', 'success');
        }

        function displayCsvFilePreview(file) {
            const placeholder = document.getElementById('csvDropPlaceholder');
            const preview = document.getElementById('csvFilePreview');
            const fileName = document.getElementById('csvFileName');
            const fileSize = document.getElementById('csvFileSize');
            
            fileName.textContent = file.name;
            fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');
        }

        function showCsvMessage(message, type) {
            const msgElement = document.getElementById('csvFormMsg');
            msgElement.textContent = message;
            msgElement.className = `text-center text-sm ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600'}`;
        }

        function showCsvProcessingSection() {
            document.getElementById('csvProcessingSection').classList.remove('hidden');
        }

        function hideCsvProcessingSection() {
            document.getElementById('csvProcessingSection').classList.add('hidden');
        }

        function resetCsvForm() {
            selectedCsvFile = null;
            document.getElementById('csvFileInput').value = '';
            document.getElementById('csvFilePreview').classList.add('hidden');
            document.getElementById('csvDropPlaceholder').classList.remove('hidden');
            showCsvMessage('', '');
        }

        // Configuración del webhook de n8n para CSV
        const N8N_CSV_WEBHOOK_URL = 'https://mateof50.app.n8n.cloud/webhook-test/upload_csv';

        // Manejar envío del formulario de CSV
        document.getElementById('csvFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedCsvFile) {
                showCsvMessage('Por favor selecciona un archivo primero', 'error');
                return;
            }

            showCsvProcessingSection();
            showCsvMessage('Enviando archivo CSV al servidor...', 'info');

            try {
                // Verificar que el usuario esté autenticado
                if (!currentUser) {
                    throw new Error('Usuario no autenticado');
                }

                // Usar el UUID del usuario autenticado
                const userUUID = currentUser.id;
                console.log('UUID del usuario autenticado:', userUUID);
                console.log('Tipo de UUID:', typeof userUUID);
                
                // Crear FormData para enviar el archivo y UUID
                const formData = new FormData();
                formData.append('file', selectedCsvFile);
                formData.append('uuid', userUUID);
                
                // Log para debugging - verificar que los datos se agregaron correctamente
                console.log('FormData creado:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}:`, value, 'Tipo:', typeof value);
                }

                // Enviar al webhook de n8n
                const response = await fetch(N8N_CSV_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                    // NO agregar Content-Type header - dejar que el navegador lo establezca automáticamente para multipart/form-data
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const result = await response.json();
                console.log('Respuesta del servidor n8n:', result);
                
                // Verificar si la respuesta indica éxito
                if (result.success || result.message === 'Workflow was started' || result.status === 'success') {
                    showCsvMessage(`¡Archivo CSV cargado correctamente! UUID del usuario: ${userUUID}. El workflow ha sido iniciado y se procesará el archivo.`, 'success');
                    
                    // Limpiar el formulario
                    resetCsvForm();
                    
                    // Actualizar la tabla de transacciones
                    fetchRecentTransactions();
                    
                    // Ocultar el formulario después de 5 segundos
                    setTimeout(() => {
                        hideForms();
                    }, 5000);
                } else {
                    throw new Error(result.message || 'Error al procesar el archivo CSV');
                }

            } catch (error) {
                console.error('Error procesando archivo CSV:', error);
                
                // Verificar si el mensaje de error es en realidad un éxito
                if (error.message && error.message.includes('Workflow was started')) {
                    showCsvMessage('¡Archivo CSV cargado correctamente! El workflow ha sido iniciado y se procesará el archivo.', 'success');
                    
                    // Limpiar el formulario
                    resetCsvForm();
                    
                    // Actualizar la tabla de transacciones
                    fetchRecentTransactions();
                    
                    // Ocultar el formulario después de 5 segundos
                    setTimeout(() => {
                        hideForms();
                    }, 5000);
                    return;
                }
                
                // Manejo específico de errores de red
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showCsvMessage('Error de conexión: No se pudo conectar con el servidor. Verifica tu conexión a internet.', 'error');
                } else if (error.message.includes('404')) {
                    showCsvMessage('Error: El webhook no fue encontrado. Verifica la URL del webhook.', 'error');
                } else if (error.message.includes('500')) {
                    showCsvMessage('Error del servidor: Problema interno en el procesamiento del archivo CSV.', 'error');
                } else if (error.message.includes('CORS')) {
                    showCsvMessage('Error de CORS: El servidor no permite la conexión desde este dominio.', 'error');
                } else {
                    showCsvMessage(`Error: ${error.message}`, 'error');
                }
            } finally {
                hideCsvProcessingSection();
            }
        });

        // --- WHATSAPP FUNCTION ---
        function openWhatsApp() {
            const phoneNumber = '+573001234567';
            const message = encodeURIComponent('Hola! Quiero registrar un gasto. ¿Cómo funciona?');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        // --- INITIALIZATION ---
        fetchCategories();
        // fetchRecentTransactions() se llama después de la autenticación
    </script>

</body>
</html> 